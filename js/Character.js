import Item from"./Item.js";const defaults={width:60,height:60,step:10,speed:80,dir:null,preturn:!1},animationLabelsByDirections={l:"left",r:"right",u:"up",d:"down"},oppositeDirections={l:"r",r:"l",u:"d",d:"u"};class Character extends Item{constructor(t){super(t),Object.keys(defaults).forEach(i=>{i in t&&(this[i]=t[i])}),this.pauseAnimation(),this.on("item:tile",()=>{this.setNextAnimation()}),this._moving=!1,this._lastX=this.x,this._lastY=this.y,this._speed=this.speed,this._dir=null,this._nextAnimation=null,this._nextDirection=null,this._moving=!1,this._saveDefaults()}_saveDefaults(){this._defaults={},["x","y","_lastX","_lastY","dir","_dir","_nextAnimation","_nextDirection","_moving","mode","animation"].forEach(t=>{this._defaults[t]=this[t]})}reset(){Object.assign(this,this._defaults),this.transform(),this.setAnimation(this.animation),this.pauseAnimation()}update(){var t=this.getTile();Math.abs(this.y-t.y)<1&&(this.y=t.y),Math.abs(this.x-t.x)<1&&(this.x=t.x),this._lastX!==this.x||this._lastY!=this.y?(this.setXYZ({x:this.x,y:this.y}),this._lastX=this.x,this._lastY=this.y,this._moving||(this.emit("item:move"),this.resumeAnimation(),this._moving=!0)):this._moving&&(this.emit("item:stop"),this.pauseAnimation(),this._moving=!1),this._nextAnimation&&this.animation!==this._nextAnimation&&this.setAnimation(this._nextAnimation)}getPositionData(){return{x:this.x,y:this.y,tile:this.getTile(),dir:this.dir}}move(t){if(t||(t=this.dir),t){var i,s=this.getTile(),h=this.getStep();if((t!=this.dir||this._preturn)&&this.canGo(t)){if((t!==this.dir&&t!==this._getOpDirection()||this._preturn)&&!this._isCentered()){if(this._isV(t)){var e=Math.abs(this.x-s.x);this.preturn?this._isCentered("x")?this._preturn=!1:(this.x>s.x?this.x-=this.getMin(e,h):this.x+=this.getMin(e,h),this._preturn=!0):i=this.getMin(e,h)}if(this._isH(t)){var n=Math.abs(this.y-s.y);this.preturn?this._isCentered("y")?this._preturn=!1:(this.y>s.y?this.y-=this.getMin(n,h):this.y+=this.getMin(n,h),this._preturn=!0):i=this.getMin(n,h)}}i||(this.dir=t,this.setNextAnimation())}i||(this.canGo(this.dir)?i=h:(this._isV(this.dir)&&(i=this.getMin(Math.abs(this.y-s.y),h)),this._isH(this.dir)&&(i=this.getMin(Math.abs(this.x-s.x),h)))),i&&("u"===this.dir&&(this.y-=i),"r"===this.dir&&(this.x+=i),"d"===this.dir&&(this.y+=i),"l"===this.dir&&(this.x-=i)),this.x<0&&(this.x=this.map.width*this.map.tileWidth),this.x>this.map.width*this.map.tileWidth&&(this.x=0),this.y<0&&(this.y=this.map.height*this.map.tileHeight),this.y>this.map.height*this.map.tileHeight&&(this.y=0),(s=this.getTile())!==this._lastTile&&(this._lastTile=s,this.emit("item:tile",s)),this.update()}}getStep(){return this.step*(this._speed/100)}setNextAnimation(){this._nextAnimation=this.animations[animationLabelsByDirections[this.dir]]}_getOpDirection(t){return oppositeDirections[t||this.dir]}canGo(t){const i=this.getTile().get(t);return i&&!i.isHouse()&&!i.isWall()}_isV(t){return"u"===t||"d"===t}_isH(t){return"l"===t||"r"===t}_isCentered(t){var i=this.getTile(),s=i.x===this.x,h=i.y===this.y;return"x"===t?s:("y"===t||s)&&h}getMin(){for(var t=null,i=0,s=arguments.length;i<s;i++)(null===t||arguments[i]<t)&&(t=arguments[i]);return t}}Object.assign(Character.prototype,defaults);export default Character;