import Game from"./engine/Game.js";import SoundManager from"./SoundManager.js";import Map from"./Map.js";import GameModel,{STATUS_SPLASH,STATUS_INTRO,STATUS_INTRO_OUT,STATUS_PLAY,STATUS_PAUSED,STATUS_GAME_OVER,STATUS_WIN}from"./GameModel.js";import makeGhost from"./factory/makeGhost.js";import makeDot from"./factory/makeDot.js";import makePill from"./factory/makePill.js";import makeBonus from"./factory/makeBonus.js";import Pacman from"./Pacman.js";import Lives from"./Lives.js";import Bonuses from"./Bonuses.js";import MainMenuDialog from"./MainMenuDialog.js";import{EVENT_KEY_DOWN,KEY_UP,KEY_RIGHT,KEY_DOWN,KEY_LEFT}from"./engine/Keyboard.js";import{EVENT_SWIPE,EVENT_SWIPE_UP,EVENT_SWIPE_RIGHT,EVENT_SWIPE_DOWN,EVENT_SWIPE_LEFT,EVENT_DOUBLE_TAP}from"./engine/Touch.js";import{EVENT_GAMEPAD_START}from"./engine/Gamepad.js";const show=s=>{s.style.display=""},hide=s=>{s.style.display="none"},defaults={width:448,height:576,originalWidth:896,originalHeight:1152,dotScore:10,pillScore:50,defaultLives:3,soundEnabled:!0,events:{"click button.start":"_onClickStartButton","click button.menu":"_onClickMenuButton"}};class JsPacman extends Game{constructor(s={}){super(s),Object.keys(defaults).forEach(t=>{t in s&&(this[t]=s[t])}),this.model=new GameModel({lives:this.defaultLives}),this.model.fetch(),this.render(),this.elements={splash:this.$(".splash"),start:this.$(".start"),menu:this.$(".menu"),startP1:this.$(".start-p1"),startReady:this.$(".start-ready"),highScore:this.$(".high-score span"),score:this.$(".p1-score span"),gameOver:this.$(".game-over"),load:this.$(".loadbar")},this.keyboard.on(EVENT_KEY_DOWN,this._onKeyDown.bind(this)),this.touch.on(EVENT_SWIPE,this._onSwipe.bind(this)),this.touch.on(EVENT_DOUBLE_TAP,this._onDoubleTap.bind(this)),this.gamepad.on(EVENT_GAMEPAD_START,this._onGamepadStart.bind(this)),this.sound=new SoundManager({soundEnabled:this.soundEnabled,addSound:this.addSound.bind(this)}),this.lives=new Lives({lives:this.defaultLives+1,x:40,y:1124,model:this.model,factor:this.scaling.getFactor(),addSprite:this.addSprite.bind(this)}),this.bonuses=new Bonuses({level:this.model.level,x:860,y:1124,model:this.model,factor:this.scaling.getFactor(),addSprite:this.addSprite.bind(this)}),this.mainMenu=new MainMenuDialog({model:this.model,factor:this.scaling.getFactor(),scaling:this.scaling,originalWidth:this.originalWidth,originalHeight:this.originalHeight,onResume:()=>{this._onMainMenuResume()}}),this.mainMenu.render(),this.el.appendChild(this.mainMenu.el),this.mainMenu.hide(),this._onGhostEaten=this._onGhostEaten.bind(this),this._onGhostEat=this._onGhostEat.bind(this),this.model.on("change:score",this._onChangeScore.bind(this)),this.model.on("change:highScore",this._onChangeHighScore.bind(this)),this.model.on("change:lives",this._onChangeLives.bind(this)),this.model.on("change:extraLives",this._onChangeExtraLives.bind(this)),this.model.on("change:mode",this._onChangeMode.bind(this)),this.model.on("change:status",this._onChangeStatus.bind(this)),this.model.on("change:mainMenuOpen",this._onChangeMainMenuOpen.bind(this)),this.model.on("change:soundEnabled",this._onChangeSoundEnabled.bind(this)),this.model.on("change:overlayEnabled",this._onChangeOverlayEnabled.bind(this)),this.makeLevel(),this.start(()=>{hide(this.elements.load),show(this.elements.start),show(this.elements.menu),this.soundEnabled&&!this.model.soundEnabled&&this.muteSound(!0)})}startLevel(){return this.model.status===STATUS_WIN?(this.model.level++,this.reset(),void(this.model.status=STATUS_INTRO_OUT)):this.model.status===STATUS_SPLASH&&this._gameOver?(this._gameOver=!1,this.model.level=1,this.reset(),hide(this.elements.splash),this.model.status=STATUS_INTRO,void this.sound.play("intro")):(hide(this.elements.splash),this.model.status=STATUS_INTRO,this.sound.play("intro"),void this.addCallback(this.mainLoop.bind(this)))}reset(){this.model.mode=null,this.pinky.destroy(),this.blinky.destroy(),this.inky.destroy(),this.sue.destroy(),this.pacman.destroy(),this.map.destroyItems(),this.off("game:ghost:eaten",this._onGhostEaten),this.off("game:ghost:eat",this._onGhostEat),this.model.status!==STATUS_WIN&&(this.model.lives=this.defaultLives+1,this.model.score=0),this.keyboard.clear(),this._inputDirection=null,this._lastSwipe=null,this.makeLevel()}makeLevel(){Object.assign(this,this.model.getSettings("game")),this.map=new Map(this.map),this.el.classList.remove("maze-1"),this.el.classList.remove("maze-2"),this.el.classList.remove("maze-3"),this.el.classList.remove("maze-4"),this.el.classList.add(this.maze);var s="white";"maze-2"===this.maze&&(s="yellow"),"maze-3"===this.maze&&(s="red"),this._pauseFrames=80,this._destroyBonus=0,this._showBonus=500;for(var t=this.map.tiles.length,e=0;t--;){var i=this.map.tiles[t];if("."===i.code){let t=makeDot({defaultAnimation:s,map:this.map,factor:this.scaling.getFactor(),normalizeRefreshRate:this.normalizeRefreshRate.bind(this),x:i.x,y:i.y});i.item=t,this.addSprite(t),e++}if("*"===i.code){let t=makePill({defaultAnimation:s,map:this.map,factor:this.scaling.getFactor(),normalizeRefreshRate:this.normalizeRefreshRate.bind(this),x:i.x,y:i.y});i.item=t,this.addSprite(t),e++}}this.totalItems=e,this.pacman=new Pacman({preturn:!0,x:452,y:848,...this.model.getSettings("pacman"),map:this.map,factor:this.scaling.getFactor(),normalizeRefreshRate:this.normalizeRefreshRate.bind(this),addGameGhostEatEventListener:s=>this.on("game:ghost:eat",s),addGameGhostModeFrightenedEnter:s=>this.on("game:ghost:modefrightened:enter",s),addGameGhostModeFrightenedExit:s=>this.on("game:ghost:modefrightened:exit",s)}),this.pacman.on("item:eatpill",()=>{this._pauseFrames=2,this.model.addScore(this.pillScore),this.totalItems--,0===this.totalItems?this.win():this.sound.play("frightened")}),this.on("game:ghost:eaten",this._onGhostEaten),this.on("game:ghost:eat",this._onGhostEat),this.pacman.on("item:die",()=>{this.sound.play("eaten")}),this.pacman.on("item:life",()=>{this.keyboard.clear(),this._inputDirection=null,this._lastSwipe=null,this.model.mode=null,this.pacman.reset(),this.pinky.reset(),this.blinky.reset(),this.inky.reset(),this.sue.reset(),this.bonus&&(this._destroyBonus=0,this._showBonus=250,this.bonus.reset(),this.bonus.hide()),this.showGhosts(),this.model.lives--,this._pacmanEaten=!1,this.model.lives>0?(show(this.elements.startReady),this.model.status=STATUS_INTRO_OUT,this._pauseFrames=40):this._pauseFrames=120}),this.pacman.on("item:eatdot",()=>{this.model.addScore(this.dotScore),this.sound.play("dot"),this.totalItems--,0===this.totalItems&&this.win()}),this.addSprite(this.pacman),this.bonus&&this.bonus.destroy();const h=this.map.tunnels[this.map.tunnels.length-1];this.bonus=makeBonus(this.bonusIndex,{map:this.map,dir:"l",score:this.bonusScore,x:h.x,y:h.y,factor:this.scaling.getFactor(),normalizeRefreshRate:this.normalizeRefreshRate.bind(this),getPacmanData:()=>this.pacman.getPositionData()}),this.bonus.on("item:destroy",s=>{s.destroy(),this.bonus=null}),this.bonus.on("item:eaten",s=>{this._showBonus||(this._pauseFrames=5,this._destroyBonus=25,this.model.addScore(parseInt(s.score)),this.sound.play("bonus"))}),this.addSprite(this.bonus);const a={...this.model.getSettings("ghost"),map:this.map,normalizeRefreshRate:this.normalizeRefreshRate.bind(this),factor:this.scaling.getFactor(),addGameGlobalModeEventListener:s=>this.on("game:globalmode",s),addGameGhostEatenEventListener:s=>this.on("game:ghost:eaten",s),getPacmanData:()=>this.pacman.getPositionData(),addPacmanEatPillEventListener:s=>this.pacman.on("item:eatpill",s)},n=this.map.houseCenter.getR();this.pinky=makeGhost("pinky",{...a,x:n.x-this.map.tileWidth/2,y:n.y}),this.addEventListenersToGhost(this.pinky),this.addSprite(this.pinky);const o=this.map.house.getU().getR();this.blinky=makeGhost("blinky",{...a,x:o.x-this.map.tileWidth/2,y:o.y}),this.addEventListenersToGhost(this.blinky),this.addSprite(this.blinky);const d=this.map.houseCenter.getL();this.inky=makeGhost("inky",{...a,blinky:this.blinky,x:d.x-16,y:d.y}),this.addEventListenersToGhost(this.inky),this.addSprite(this.inky);const l=this.map.houseCenter.getR().getR();this.sue=makeGhost("sue",{...a,x:l.x+16,y:l.y}),this.addEventListenersToGhost(this.sue),this.addSprite(this.sue),show(this.elements.startReady),this.model.status===STATUS_WIN?(this.bonus.hide(),this.model.status=STATUS_INTRO_OUT):(show(this.elements.startP1),this.hideGhosts(),this.pacman.hide())}addEventListenersToGhost(s){s.on("item:eat",()=>this.emit("game:ghost:eat",s)),s.on("item:eaten",()=>this.emit("game:ghost:eaten",s)),s.on("item:modefrightened:enter",()=>this.emit("game:ghost:modefrightened:enter",s)),s.on("item:modefrightened:exit",()=>this.emit("game:ghost:modefrightened:exit",s))}mainLoop(){if(this.model.status===STATUS_PLAY&&this.model.updateMode(),this._inputDirection=this._getInputDirection(),this._pauseFrames)this._pauseFrames--;else{if(this.model.status===STATUS_SPLASH)return;if(this.model.status===STATUS_INTRO)return hide(this.elements.startP1),this.showGhosts(),this.pacman.show(),this.model.lives=this.defaultLives,this._pauseFrames=60,void(this.model.status=STATUS_INTRO_OUT);if(this.model.status===STATUS_INTRO_OUT)return hide(this.elements.startReady),void(this.model.status=STATUS_PLAY);if(this.model.status===STATUS_WIN)return void this.startLevel();if(this.model.status===STATUS_GAME_OVER)return hide(this.elements.gameOver),show(this.elements.splash),this._gameOver=!0,void(this.model.status=STATUS_SPLASH);this._showPacman&&(this.pacman.show(),this._showPacman=!1),this.pacman.move(this._inputDirection),this._pacmanEaten?this.hideGhosts():(this._soundBackPauseFrames?this._soundBackPauseFrames--:(this._isGhostDead()?this.sound.play("dead"):this._isGhostFrightened()||this.sound.play("back"),this._soundBackPauseFrames=5),this.pinky.move(),this.blinky.move(),this.inky.move(),this.sue.move(),this._destroyBonus?(1===this._destroyBonus&&(this.bonus.destroy(),delete this.bonus),this._destroyBonus--):this.bonus&&(this._showBonus?(1===this._showBonus&&this.bonus.show(),this._showBonus--):this.bonus.move()))}}pause(){super.pause(),this.model.mainMenuOpen=!0,this.pinky.pause(),this.blinky.pause(),this.inky.pause(),this.sue.pause(),this.soundEnabled&&this.muteSound(!0),this.model.pause()}resume(){super.resume(),this.model.mainMenuOpen=!1,this.pinky.resume(),this.blinky.resume(),this.inky.resume(),this.sue.resume(),this.soundEnabled&&this.muteSound(!this.model.soundEnabled),this.model.resume()}win(){this.model.status=STATUS_WIN,this._pauseFrames=120;let s=14;this.addCallback(()=>s?(s--,this.el.classList.toggle("blink"),!1):(this.el.classList.remove("blink"),!0),8*this.refreshRate),this.hideGhosts(),this.map.hideItems(),this.pacman.pauseAnimation()}hideGhosts(){this.pinky.hide(),this.blinky.hide(),this.inky.hide(),this.sue.hide(),this.bonus&&this.bonus.hide()}showGhosts(){this.pinky.show(),this.blinky.show(),this.inky.show(),this.sue.show(),this.bonus&&!this._showBonus&&this.bonus.show()}_isGhostFrightened(){return this.blinky.isFrightened()||this.inky.isFrightened()||this.pinky.isFrightened()||this.sue.isFrightened()}_isGhostDead(){return this.blinky.isDead()||this.inky.isDead()||this.pinky.isDead()||this.sue.isDead()}_getInputDirection(){const s=this.keyboard.keys;let t=null;return s[KEY_UP]?t="u":s[KEY_RIGHT]?t="r":s[KEY_DOWN]?t="d":s[KEY_LEFT]&&(t="l"),t||(t=this.gamepad.getDirection()),t?this._lastSwipe=null:this._lastSwipe===EVENT_SWIPE_UP?t="u":this._lastSwipe===EVENT_SWIPE_RIGHT?t="r":this._lastSwipe===EVENT_SWIPE_DOWN?t="d":this._lastSwipe===EVENT_SWIPE_LEFT&&(t="l"),t}onLoadProgress(s){this.elements.load.querySelector(".inner").style.width=`${s}%`}_onSwipe(s){this._lastSwipe=s}_onDoubleTap(){this.model.status===STATUS_PLAY&&(this.model.status=STATUS_PAUSED)}_onGamepadStart(){this.model.status===STATUS_SPLASH?this.startLevel():this.model.status===STATUS_PLAY?this.model.status=STATUS_PAUSED:this.model.status===STATUS_PAUSED&&(this.model.status=STATUS_PLAY)}_onKeyDown(s){"Escape"===s.key&&(this.model.status===STATUS_PLAY?this.model.status=STATUS_PAUSED:this.model.status===STATUS_PAUSED?this.model.status=STATUS_PLAY:this.model.status===STATUS_SPLASH&&(this.model.mainMenuOpen=!this.model.mainMenuOpen))}_onClickStartButton(){this.startLevel()}_onClickMenuButton(){this.model.status!==STATUS_SPLASH&&this.model.status!==STATUS_PAUSED||(this.model.mainMenuOpen=!0)}_onMainMenuResume(){this.model.status===STATUS_PAUSED?this.model.status=STATUS_PLAY:this.model.status===STATUS_SPLASH&&(this.model.mainMenuOpen=!1)}_onChangeStatus(s,t){s.previous.status===STATUS_PLAY&&t===STATUS_PAUSED?this.pause():s.previous.status===STATUS_PAUSED&&t===STATUS_PLAY&&this.resume()}_onChangeScore(s,t){this.elements.score.innerText=t||"00"}_onChangeHighScore(s,t){this.elements.highScore.innerText=t||"00"}_onChangeLives(s,t){0===t&&(this.model.status=STATUS_GAME_OVER,show(this.elements.gameOver),this.hideGhosts(),this.pacman.hide(),this.model.save())}_onChangeExtraLives(){this.sound.play("life")}_onChangeMode(s,t){this.emit("game:globalmode",t)}_onChangeMainMenuOpen(s,t){t?this.mainMenu.show():this.mainMenu.hide()}_onChangeSoundEnabled(s,t){this.soundEnabled&&(this.muteSound(!t),this.model.save())}_onChangeOverlayEnabled(s,t){this.el.classList.toggle("with-overlay",t),this.el.classList.toggle("with-light",t),this.model.save()}_onGhostEaten(s){this.pacman.hide(),this._pauseFrames=15,this._showPacman=!0,this.model.addScore(parseInt(s.score)),this.sound.play("eat")}_onGhostEat(){this._pauseFrames=40,this._pacmanEaten=!0}render(){return this.el.innerHTML=`\n            <div class="score">\n                <div class="p1-score">1UP<br /><span>00</span></div>\n                <div class="high-score">HIGH SCORE<br /><span>${Game.sanitize(this.model.highScore)||"00"}</span></div>\n                <div class="p2-score">2UP<br /><span>00</span></div>\n            </div>\n            <div class="start-p1" style="display: none">PLAYER ONE</div>\n            <div class="start-ready" style="display: none">READY!</div>\n            <div class="game-over" style="display: none">GAME OVER</div>\n            <div class="splash">\n                <span class="title">"JS PAC-MAN"</span>\n                <p class="message">HTML - CSS<br><br><span>JAVASCRIPT</span></p>\n                <button class="start" style="display: none">START</button>\n                <button class="menu" style="display: none">MENU</button>\n                <div class="loadbar"><div class="inner"></div></div>\n                <div class="credits">&#169; 2014-${(new Date).getFullYear()} <span>8</span>TENTACULOS <a href="https://github.com/8tentaculos/jsPacman" target="_blank">SOURCE+INFO</a></div>\n            </div>\n        `,this.el.classList.add("with-border"),this.model.overlayEnabled&&this.el.classList.add("with-overlay","with-light"),super.render(),this}}Object.assign(JsPacman.prototype,defaults);export default JsPacman;