import Animation,{ANIMATION_HORIZONTAL}from"./engine/Animation.js";import Timer from"./engine/Timer.js";import Character from"./Character.js";import getDistance from"./helper/getDistance.js";import rnd from"./helper/rnd.js";export const MODE_SCATTER="scatter";export const MODE_CHASE="chase";export const MODE_FRIGHTENED="frightened";export const MODE_HOUSE="house";export const MODE_DEAD="dead";export const animationBase={imageURL:"img/characters.png",numberOfFrame:2,delta:64,refreshRate:180,type:ANIMATION_HORIZONTAL};export const animations={frightened:new Animation({...animationBase,offsetY:376,offsetX:-2}),frightenedBlink:new Animation({...animationBase,offsetY:376,offsetX:-2,numberOfFrame:4}),deadRight:new Animation({...animationBase,offsetY:376,offsetX:254,numberOfFrame:1}),deadDown:new Animation({...animationBase,offsetY:376,offsetX:318,numberOfFrame:1}),deadUp:new Animation({...animationBase,offsetY:376,offsetX:382,numberOfFrame:1}),deadLeft:new Animation({...animationBase,offsetY:376,offsetX:446,numberOfFrame:1}),score200:new Animation({...animationBase,imageURL:"img/misc.png",numberOfFrame:1,offsetX:-2,offsetY:110}),score400:new Animation({...animationBase,imageURL:"img/misc.png",numberOfFrame:1,offsetX:62,offsetY:110}),score800:new Animation({...animationBase,imageURL:"img/misc.png",numberOfFrame:1,offsetX:126,offsetY:110}),score1600:new Animation({...animationBase,imageURL:"img/misc.png",numberOfFrame:1,offsetX:192,offsetY:110})};const defaults={animations:animations,width:64,speed:75,frightenedTime:5,waitTime:4,scatterTarget:0,mode:"house",score:"200",scores:{200:"400",400:"800",800:"1600"},blinky:null,getChaseTarget:function(){return this.getPacmanData().tile},tunnelSpeed:null,frightenedSpeed:null,frightenedFlashes:null};class Ghost extends Character{constructor(e){super(e),Object.keys(defaults).forEach(t=>{t in e&&(this[t]=e[t])}),this.getPacmanData=e.getPacmanData;const{addGameGlobalModeEventListener:t,addGameGhostEatenEventListener:i,addPacmanEatPillEventListener:s}=e;this.deadTarget=this.map.house.getR().getU(),this.deadEndX=this._defaults.x,this.deadEndY=this.map.houseCenter.y,this.deadEnd=this.map.getTile(this.deadEndX,this.deadEndY,!0),this.houseTop=this.y-this.getTile().height/2,this.houseBottom=this.y+this.getTile().height/2,this.houseExitTile=this.map.house.getR(),this.houseExitTileX=this.houseExitTile.x-this.map.tileWidth/2,this.scatterTarget=this.map.tiles[this.scatterTarget],this.setMode(this.mode),this.on("item:tile",e=>{"frightened"===this.mode?this._speed=this.frightenedSpeed:"dead"===this.mode?this._speed=130:e.isTunnel()?this._speed=this.tunnelSpeed:this._speed=this.speed,this._turnBack?(this.dir=this._getOpDirection(this.dir),this._dir=null,this._nextDir=this.getNextDirection(),this._turnBack=!1):(this._dir=this._nextDir,this._nextDir=this.getNextDirection()),this._eatEvent=!1}),t(this.onGameGlobalMode.bind(this)),s(()=>{this.setMode("frightened"),this.score=200}),i(()=>{this.score=this.scores[this.score]})}reset(){super.reset(),this.setMode(this.mode)}pause(){this.houseTimer&&this.houseTimer.pause(),this.frightenedTimer&&this.frightenedTimer.pause()}resume(){"frightened"===this.mode&&this.frightenedTimer.resume(),"house"!==this.mode||this.housePrepareExit||this.houseTimer.resume()}setMode(e){if(!e){if(this.frightened)return this.mode=this.frightened,void(this.frightened=null);e=this.globalMode}"frightened"!==e||"house"!==this.mode&&"dead"!==this.mode?this.mode=e:this.frightened=e,this.onEnterMode(e)}shouldExitMode(){return"dead"===this.mode?this.getTile()===this.deadEnd:"frightened"===this.mode?this.frightenedTimer.isElapsed():"house"===this.mode?this.getTile()===this.houseExitTile.getU():this.mode!=this.globalMode}onEnterMode(e){switch(e){case"dead":this.emit("item:modefrightened:exit"),this.deadPrepareEnter=!1,this._nextAnimation=this.animations[`score${this.score}`],this.update();break;case"frightened":this.frightenedTimer=new Timer(this.frightenedTime),this.emit("item:modefrightened:enter");break;case"house":this.housePrepareExit=!1,this._speed=70}}onExitMode(){const e=this.getTile();switch(this.mode){case"dead":this.reset();break;case"frightened":this.setMode(),this.emit("item:modefrightened:exit");break;case"house":this.houseTimer=null,this._dir="l",this._nextDir="l",this._lastTile=e.getD(),this._speed=this.speed,this.setMode();break;default:e.isHouse()||(this._turnBack=!0),this.setMode()}}isFrightened(){return this.frightened||"frightened"===this.mode}isDead(){return"dead"===this.mode}onGameGlobalMode(e){e&&(this.globalMode=e)}move(){if(this.shouldExitMode())this.onExitMode();else if("dead"===this.mode)if(this.deadPrepareEnter||this.getTile()!==this.deadTarget||(this.deadPrepareEnter=!0),this.deadPrepareEnter){let e=this.deadEndX,t=this.deadEndY;this.y<t&&(e=this.deadTarget.x-this.map.tw/2),this.x<e?this.dir="r":this.x>e?this.dir="l":this.y<t&&(this.dir="d"),"d"===this.dir&&(this.y+=this.getMin(this.getStep(),t-this.y)),"r"===this.dir&&(this.x+=this.getMin(this.getStep(),e-this.x)),"l"===this.dir&&(this.x-=this.getMin(this.getStep(),this.x-e)),this.setNextAnimation(),this.update()}else super.move(this._dir);else if("house"===this.mode){this.houseTimer||(this.houseTimer=new Timer(this.waitTime));const e=this.getTile();this.housePrepareExit||!this.houseTimer.isElapsed()||e.isWall()||(this.housePrepareExit=!0,this.y=e.y),this.frightened&&this.frightenedTimer.isElapsed()&&(this.frightened=null),this.housePrepareExit?(this.x<this.houseExitTileX?this.dir="r":this.x>this.houseExitTileX?this.dir="l":this.dir="u","u"===this.dir&&(this.y-=this.getMin(this.getStep(),this.y-this.houseExitTile.getU().y)),"r"===this.dir&&(this.x+=this.getMin(this.getStep(),this.houseExitTileX-this.x)),"l"===this.dir&&(this.x-=this.getMin(this.getStep(),this.x-this.houseExitTileX))):(this.y<=this.houseTop&&"u"===this.dir&&(this.dir="d"),this.y>=this.houseBottom&&"d"===this.dir&&(this.dir="u"),"u"===this.dir&&(this.y-=this.getMin(this.getStep(),this.y-this.houseTop)),"d"===this.dir&&(this.y+=this.getMin(this.getStep(),this.houseBottom-this.y))),this.setNextAnimation(),this.update()}else super.move(this._dir);if(!this._eatEvent){const s=this.getPacmanData();var e=s.tile,t=this.getTile(),i=this._getOpDirection(this.dir);(e===t||s.dir===i&&e===t.get(i))&&(this._eatEvent=!0,"frightened"===this.mode?(this.setMode("dead"),this.emit("item:eaten")):"dead"!==this.mode&&this.emit("item:eat"))}}canGo(e,t){t||(t=this.getTile());const i=t.get(e);return"dead"===this.mode?!i||!i.isWall():!!i&&(!i.isWall()&&!i.isHouse())}getNextDirection(){if("frightened"===this.mode){const e=this.getTile().get(this._dir),t=["u","r","d","l","u","r","d","l"];let i=rnd(4),s=t[i];for(;s&&(s===this._getOpDirection(this._dir)||!this.canGo(s,e));)s=t[++i];return s}const e="chase"===this.mode?this.getChaseTarget():"scatter"===this.mode?this.scatterTarget:this.deadTarget,t=this._dir||this.dir,i=this.getTile().get(t),s=["u","l","d","r"];let h,n;for(let a=0;a<4;a++){let r=s[a];if(r!==this._getOpDirection(t)&&this.canGo(r,i)){const t=i.get(r),s=getDistance(t,e);(void 0===n||n>s)&&(h=r,n=s)}}return h}setNextAnimation(){if("dead"===this.mode)switch(this.dir){case"u":this._nextAnimation=this.animations.deadUp;break;case"r":this._nextAnimation=this.animations.deadRight;break;case"d":this._nextAnimation=this.animations.deadDown;break;case"l":this._nextAnimation=this.animations.deadLeft}else"frightened"===this.mode||"house"===this.mode&&this.frightened?this.frightenedTimer.isElapsed(.75*this.frightenedTime)?this._nextAnimation=this.animations.frightenedBlink:this._nextAnimation=this.animations.frightened:super.setNextAnimation()}}Object.assign(Ghost.prototype,defaults);export default Ghost;