import View from"rasti/View.js";import Keyboard from"./Keyboard.js";import Touch from"./Touch.js";import Gamepad from"./Gamepad.js";import Scaling from"./Scaling.js";export const STATE_NEW=0;export const STATE_RUNNING=1;export const STATE_PAUSED=2;const defaults={height:320,width:480,originalHeight:320,originalWidth:480,refreshRate:30,position:"absolute"};class Game extends View{constructor(s){super(s),Object.keys(defaults).forEach(e=>{e in s&&(this[e]=s[e])}),this.sprites=this.children,this.sounds=[],this.callbacks=[],this.loadedSpritesIndex=0,this.loadedSoundsIndex=0,this.keyboard=new Keyboard,this.touch=new Touch,this.gamepad=new Gamepad,this.scaling=new Scaling(this.originalWidth,this.originalHeight),this.scaling.resize(this.width,this.height),this.state=0}render(){return Object.assign(this.el.style,{position:this.position,display:"block",overflow:"hidden",height:`${this.scaling.height}px`,width:`${this.scaling.width}px`,fontSize:2*this.scaling.getFactor()+"em"}),this.scenegraph=this.createElement("div",{style:"visibility: hidden;"}),this.el.appendChild(this.scenegraph),this}onDestroy(){this.keyboard.destroy(),this.touch.destroy(),this.gamepad.destroy()}preload(){for(let s=this.sprites.length-1;s>=this.loadedSpritesIndex;s--)this.sprites[s].load();for(let s=this.sounds.length-1;s>=this.loadedSoundsIndex;s--)this.sounds[s].load();this.waitForResources()}waitForResources(){let s=0;for(let e=this.loadedSpritesIndex;e<this.sprites.length;e++)this.sprites[e].isReady()&&s++;let e=0;for(let s=this.loadedSoundsIndex;s<this.sounds.length;s++)this.sounds[s].isReady()&&e++;const t=this.sprites.length+this.sounds.length-this.loadedSpritesIndex-this.loadedSoundsIndex;if("function"==typeof this.onLoadProgress){let i=(s+e)/t*100;this.onLoadProgress(i)}s+e<t?setTimeout(this.waitForResources.bind(this),100):(this.loadedSpritesIndex=this.sprites.length,this.loadedSoundsIndex=this.sounds.length,0===this.state&&setInterval(this.refresh.bind(this),this.refreshRate),this.state=1,"function"==typeof this._onReadyCallback&&(this._onReadyCallback(),this._onReadyCallback=null),this.scenegraph.style.visibility="visible")}addSprite(s){return this.scenegraph.appendChild(this.addChild(s).el),1===this.state?s.load().then(()=>(this.loadedSpritesIndex++,Promise.resolve())):Promise.resolve()}addSound(s){return this.sounds.push(s),1===this.state?s.load().then(()=>(this.loadedSoundsIndex++,Promise.resolve())):Promise.resolve()}addCallback(s,e=this.refreshRate){this.callbacks.push({fn:s,refreshRate:this.normalizeRefreshRate(e),idleCounter:0})}refresh(){if(this.gamepad.refresh(),1===this.state){this.sprites.forEach(s=>{s.refresh()});const s=[];for(let e=this.callbacks.length-1;e>=0;e--){if(this.callbacks[e].idleCounter===this.callbacks[e].refreshRate-1){const t=this.callbacks[e].fn();"boolean"==typeof t?t&&s.push(e):"number"==typeof t&&(this.callbacks[e].refreshRate=this.normalizeRefreshRate(t),this.callbacks[e].idleCounter=0)}this.callbacks[e].idleCounter=(this.callbacks[e].idleCounter+1)%this.callbacks[e].refreshRate}for(let e=s.length-1;e>=0;e--)this.callbacks.splice(s[e],1)}}clear(s){this.destroyChildren(),this.loadedSpritesIndex=0,this.sounds=[],this.loadedSoundsIndex=0,s&&(this.callbacks=[]),this.scenegraph.innerHTML=""}muteSound(s){for(let e=this.sounds.length-1;e>=0;e--)this.sounds[e].mute(s)}start(s){"function"==typeof s&&(this._onReadyCallback=s),this.preload()}pause(){this.state=2,this.scenegraph.style.visibility="hidden"}resume(s){2===this.state&&("function"==typeof s&&(this._onReadyCallback=s),this.preload())}normalizeRefreshRate(s){return Math.round(s/this.refreshRate)||1}}Object.assign(Game.prototype,defaults);export default Game;