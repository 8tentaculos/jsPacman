import View from"rasti/View.js";import{ANIMATION_HORIZONTAL,ANIMATION_VERTICAL,ANIMATION_ONCE,ANIMATION_CALLBACK,ANIMATION_PINGPONG}from"./Animation.js";const defaults={width:32,height:32,x:0,y:0,z:0,offsetX:0,offsetY:0,idleCounter:0,currentFrame:0,frameIncrement:1,angle:0,factor:1,playing:!0,factorH:1,factorV:1,animations:{},defaultAnimation:"default",normalizeRefreshRate:null,type:null};class Sprite extends View{constructor(t){super(t),Object.keys(defaults).forEach(i=>{i in t&&(this[i]=t[i])})}load(){return Promise.all(Object.keys(this.animations).map(t=>this.animations[t].load()))}isReady(){return Object.keys(this.animations).some(t=>!!this.animations[t].isReady())}render(){return Object.assign(this.el.style,{position:"absolute",overflow:"hidden",height:`${this.height}px`,width:`${this.width}px`,zIndex:this.z}),this.animations[this.defaultAnimation]&&this.setAnimation(this.animations[this.defaultAnimation]),this.transform(),this}refresh(){if(this.animation){if(this.idleCounter===this.normalizeRefreshRate(this.animation.refreshRate)-1&&this.playing&&(this.animation.type&ANIMATION_ONCE?this.currentFrame<this.animation.numberOfFrame-1?this.currentFrame+=this.frameIncrement:this.currentFrame==this.animation.numberOfFrame-1&&this.animation.type&ANIMATION_CALLBACK&&"function"==typeof this.callback&&(this.callback(this),this.callback=null):(this.animation.type&ANIMATION_PINGPONG&&(this.currentFrame===this.animation.numberOfFrame-1&&1===this.frameIncrement?this.frameIncrement=-1:0===this.currentFrame&&-1===this.frameIncrement&&(this.frameIncrement=1)),this.currentFrame=(this.currentFrame+this.frameIncrement)%this.animation.numberOfFrame,0===this.currentFrame&&this.animation.type&ANIMATION_CALLBACK&&"function"==typeof this.callback&&this.callback(this)),this.animation.numberOfFrame>1)){let t=0,i=0;this.animation.type&ANIMATION_VERTICAL?(t=-this.animation.offsetX,i=-this.animation.offsetY-this.animation.delta*this.currentFrame):this.animation.type&ANIMATION_HORIZONTAL&&(t=-this.animation.offsetX-this.animation.delta*this.currentFrame,i=-this.animation.offsetY),this.el.style.backgroundPosition=`${t}px ${i}px`}this.idleCounter=(this.idleCounter+1)%this.normalizeRefreshRate(this.animation.refreshRate)}}pauseAnimation(){this.playing=!1}resumeAnimation(){this.playing=!0}setAnimation(t,i,e){this.animation=t,this.currentFrame=0,this.frameIncrement=1,this.el.style.backgroundImage=`url('${t.imageURL}')`,t.type&ANIMATION_VERTICAL?this.el.style.backgroundRepeat="repeat-x":t.type&ANIMATION_HORIZONTAL?this.el.style.backgroundRepeat="repeat-y":this.el.style.backgroundRepeat="no-repeat";this.el.style.backgroundPosition=`${-0-t.offsetX}px ${-0-t.offsetY}px`,"function"==typeof e&&(this.callback=e)}transform(){this.el.style.transform=`translate(${this.x*this.factor-this.offsetX}px, ${this.y*this.factor-this.offsetY}px) rotate(${this.angle}deg) scale(${this.factor*this.factorH}, ${this.factor*this.factorV})`}rotate(t,i){!0===i&&(t+=this.angle,t%=360),this.angle=parseFloat(t),this.transform()}scale(t,i){!0===i&&(t*=this.factor),this.factor=parseFloat(t),this.transform()}flipH(t){if(void 0===t)return void 0!==this.factorH&&-1===this.factorH;this.factorH=t?-1:1,this.transform()}flipV(t){if(void 0===t)return void 0!==this.factorV&&-1===this.factorV;this.factorV=t?-1:1,this.transform()}setXYZ(t,i){let e=!1;Object.keys(t).forEach(s=>{switch(s){case"x":i&&(t.x+=this.x),this.x=t.x,e=!0;break;case"y":i&&(t.y+=this.y),this.y=t.y,e=!0;break;case"z":i&&(t.z+=this.z),this.z=t.z,this.el.style.zIndex=this.z}}),e&&this.transform()}setWH(t,i){Object.keys(t).forEach(e=>{switch(e){case"w":i&&(t.w+=this.width),this.width=t.w,this.el.style.width=`${this.width}px`;break;case"h":i&&(t.h+=this.height),this.height=t.h,this.el.style.height=`${this.height}px`}})}}Object.assign(Sprite.prototype,defaults);export default Sprite;